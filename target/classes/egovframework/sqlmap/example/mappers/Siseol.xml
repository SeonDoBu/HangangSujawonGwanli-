<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="egovframework.example.sample.service.impl.SiseolMapper">

	<select id="siseolCount" parameterType="Siseol" resultType="int">
		select count(*)
		from    siseol
		<where>
			<if test="big_code != 0">
				 big_code = ${big_code}
			</if>
			<if test="small_code != 0">
				  AND small_code = ${small_code}
			</if>
			<if test="district_id != 0">
				  AND district_id = ${district_id}
			</if>
			<if test="gigwan_id != 0">
				  AND gigwan_id   = ${gigwan_id}
			</if>
			<if test="siseol_id != 0">
				  AND siseol_id   = ${siseol_id}
			</if>
		</where>   
	</select>
	
	<select id="siseolList" parameterType="Siseol" resultType="Siseol">
		SELECT b.*
		FROM
		(
			SELECT  ROW_NUMBER() OVER (ORDER BY siseol_id) AS rn, a.*
			FROM
			   (
				SELECT s.*, d.name AS districtName, g.name AS gigwanName, c.content AS siseolName
				FROM SISEOL s
				JOIN COMMONCODE c ON s.small_code = c.small_code AND s.big_code = c.big_code
				JOIN DISTRICT d ON s.district_id = d.district_id
				JOIN GIGWAN g ON s.gigwan_id = g.gigwan_id
				<where>
					<if test="big_code != 0">
						 s.big_code = ${big_code}
					</if>
					<if test="small_code != 0">
						  AND s.small_code = ${small_code}
					</if>
					<if test="district_id != 0">
						  AND s.district_id = ${district_id}
					</if>
					<if test="gigwan_id != 0">
						  AND s.gigwan_id   = ${gigwan_id}
					</if>
					<if test="siseol_id != 0">
						  AND s.siseol_id   = ${siseol_id}
					</if>
				</where> 
				)a
		)b
		WHERE rn BETWEEN #{start} and #{end}
	</select>
	
	<select id="commonList" resultType="Commoncode">
		SELECT *
		FROM Commoncode
		WHERE big_code = 2
		AND NOT (small_code = 999);
	</select>
	
	<select id="districtList" resultType="District">
		select *
		from   District
	</select>
	
	<select id="gigwanList" resultType="Gigwan">
		select *
		from   Gigwan
	</select>
	
	<!-- 시설물 코드에 해당하는 시설물의 정보를 조회 by 나희 -->
	<select id="siseolDetail" parameterType="int" resultType="Siseol">
		SELECT s.*,
	   		   (SELECT content FROM commoncode c WHERE c.big_code = s.big_code AND c.small_code = s.small_code) AS siseolName,
	   		   (SELECT name FROM gigwan g WHERE g.gigwan_id = s.gigwan_id) AS gigwanName, 
	   		   (SELECT name FROM district d WHERE d.district_id = s.district_id) AS districtName
		FROM   siseol s
		WHERE  s.siseol_id = #{siseolId}
	</select>
	
	<insert id="inspectionInsert" parameterType="Inspection" >
		INSERT INTO INSPECTION (INSP_ID, USER_ID, SISEOL_ID, INSP_DATE, WEATHER, INSP_RESULT, SPECIAL_NOTE, INSP_RECORD,
		UP1_SCORE, UP1_NOTE, UP2_SCORE, UP2_NOTE, UP3_SCORE, UP3_NOTE, UP4_SCORE, UP4_NOTE, DOWN1_SCORE, DOWN1_NOTE,
		DOWN2_SCORE, DOWN2_NOTE, DOWN3_SCORE, DOWN3_NOTE, DOWN4_SCORE, DOWN4_NOTE, INSPEC1_SCORE, INSPEC1_NOTE,
		INSPEC2_SCORE, INSPEC2_NOTE)
		VALUES
		((SELECT MAX(INSP_ID) + 1 FROM INSPECTION), #{USER_ID}, #{SISEOL_ID}, #{INSP_DATE}, #{WEATHER}, #{INSP_RESULT}, #{SPECIAL_NOTE}, #{INSP_RECORD}, 
		#{UP1_SCORE}, #{UP1_NOTE}, #{UP2_SCORE}, #{UP2_NOTE}, #{UP3_SCORE}, #{UP3_NOTE}, #{UP4_SCORE}, #{UP4_NOTE}, 
		#{DOWN1_SCORE}, #{DOWN1_NOTE}, #{DOWN2_SCORE}, #{DOWN2_NOTE}, #{DOWN3_SCORE}, #{DOWN3_NOTE}, #{DOWN4_SCORE}, #{DOWN4_NOTE}, 
		#{INSPEC1_SCORE}, #{INSPEC1_NOTE}, #{INSPEC2_SCORE}, #{INSPEC2_NOTE});
	</insert>
	
	<!-- 시설물 정보 insert by 나희 -->
	<insert id="siseolInsert" parameterType="Siseol">
		INSERT INTO siseol(siseol_id, big_code, small_code, district_id, gigwan_id, mapx, mapy, address, is_deleted) 
		VALUES(#{siseol_id}, 2, #{small_code}, #{district_id}, #{gigwan_id}, #{mapx}, #{mapy}, #{address}, 0)
	</insert>
	
	<!-- 시설물 정보 update by 나희 -->
	<update id="siseolUpdate" parameterType="Siseol">
		UPDATE siseol
		SET    small_code = #{small_code}, district_id = #{district_id}, gigwan_id = #{gigwan_id},
		       mapx = #{mapx}, mapy = #{mapy}, address = #{address}
		WHERE  siseol_id = #{siseol_id}
	</update>
	
	<!-- 시설물 정보 delete(is_deleted 값 변경) by 나희 -->
	<update id="siseolDelete" parameterType="int">
		UPDATE siseol
		SET    is_deleted = '1'
		WHERE  siseol_id = #{siseolId}
	</update>

</mapper>